<html>

<head>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@3.11.0/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/posenet@2.2.2/dist/posenet.min.js"></script>
    <style>
        /* 이미지에 캔버스를 겹쳐서 그릴때는 아래 주석 해제 */
        canvas {
            position: absolute;
        }

        img {
            position: absolute;
        }
    </style>
</head>

<body>
    <canvas id="canvas"></canvas>
    <!-- <video id="video" width="1200" height="800" "autoplay muted playsinline src='../images/2_people.mp4 '></video> -->
    <video id="video" width="800" height="600" autoplay muted playsinline></video>
</body>

<script>
    const video = document.getElementById("video");
    const canvas = document.getElementById("canvas");
    const context = canvas.getContext("2d");
    const start = Date.now() / 1000;

    let myReq;

    // 웹캠 사용 시 주석 해제
    navigator.mediaDevices.getUserMedia({ video: true, audio: false })
        .then(function (stream) {
            video.srcObject = stream;
        });

    posenet.load({
        //architecture: 'ResNet50',
        architecture: 'MobileNetV1',

    }).then(function (model) {
        video.onloadeddata = (e) => {
            predict();
        }
        function predict() {
            const date = new Date();
            const timestamp = Math.floor(+ date.getTime() / 1000);
            const progress = timestamp - start;

            console.log(progress);
            // if (progress < 5) {
                model.estimateMultiplePoses(video,
                    {
                        maxDetections: 100,
                    }
                ).then(pose => {
                    canvas.width = video.width;
                    canvas.height = video.height;
                    //console.log(pose.length);

                    for (let i = 0; i < pose.length; i++) {
                        console.log('Keypoints JSON', JSON.stringify(pose[i].keypoints));

                        drawKeypoints(pose[i].keypoints, 0.6, context);
                        drawSkeleton(pose[i].keypoints, 0.6, context);

                        // let head = [];
                        // for (let j = 0; j < 7; j++) {
                        //     head.push(pose[i].keypoints[j]);
                        // }
                        // // console.log(head);
                        // let body = [];
                        // for (let j = 5; j < 13; j++) {
                        //     body.push(pose[i].keypoints[j]);
                        // }
                        // let leg = [];
                        // for (let j = 11; j < 17; j++) {
                        //     leg.push(pose[i].keypoints[j]);
                        // }
                        // drawBoundingBox(head, context);
                        // drawBoundingBox(body, context);
                        // drawBoundingBox(leg, context);

                        const boundingBox = posenet.getBoundingBox(pose[i].keypoints);
                        console.log("R값 : ", (boundingBox.maxX - boundingBox.minX) / (boundingBox.maxY - boundingBox.minY));
                    }

                });
                myReq = requestAnimationFrame(predict);
            // }
            // myReq = requestAnimationFrame(predict);
            // cancelAnimationFrame(myReq);
        }
    })

</script>
<script src="posenet.js"></script>

</html>